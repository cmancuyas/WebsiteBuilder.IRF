@page
@model WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel

@{
    ViewData["Title"] = "Media Usage";
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <div>
        <h2 class="mb-0">Media Usage</h2>
        <div class="text-muted small">Tenant-scoped storage and activity overview.</div>
    </div>

    <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" asp-page="/Admin/Media/Index">Back</a>
        <a class="btn btn-outline-secondary" asp-page="/Admin/Media/List">Library</a>
        <a class="btn btn-outline-danger" asp-page="/Admin/Media/Trash">Trash</a>
    </div>
</div>

@if (!Model.IsTenantResolved)
{
    <div class="alert alert-warning mb-0">
        Tenant is not resolved. Usage dashboard cannot be displayed.
    </div>
    return;
}

<div class="row g-3 mb-3">
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted small">Active Media</div>
                <div class="fs-3 fw-semibold">@Model.Summary.ActiveCount</div>
                <div class="text-muted small">@WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel.FormatBytes(Model.Summary.ActiveBytes)</div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted small">Deleted Media</div>
                <div class="fs-3 fw-semibold">@Model.Summary.DeletedCount</div>
                <div class="text-muted small">@WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel.FormatBytes(Model.Summary.DeletedBytes)</div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted small">Total Media</div>
                <div class="fs-3 fw-semibold">@Model.Summary.TotalCount</div>
                <div class="text-muted small">@WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel.FormatBytes(Model.Summary.TotalBytes)</div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="text-muted small">Retention Reminder</div>
                <div class="small">
                    Deleted items are removable after retention. Restore from Trash before cleanup.
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <div class="fw-semibold">Monthly Upload Trend (last 12 months)</div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Month</th>
                                <th class="text-end">Count</th>
                                <th class="text-end">Bytes</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.MonthlyUsage.Count == 0)
                            {
                                <tr><td colspan="3" class="text-muted p-3">No uploads in the last 12 months.</td></tr>
                            }
                            else
                            {
                                foreach (var r in Model.MonthlyUsage)
                                {
                                    <tr>
                                        <td>@r.Label</td>
                                        <td class="text-end">@r.Count</td>
                                        <td class="text-end">@WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel.FormatBytes(r.Bytes)</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <div class="fw-semibold">Top Content Types (active)</div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Content Type</th>
                                <th class="text-end">Count</th>
                                <th class="text-end">Bytes</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.ByContentType.Count == 0)
                            {
                                <tr><td colspan="3" class="text-muted p-3">No active media.</td></tr>
                            }
                            else
                            {
                                foreach (var r in Model.ByContentType)
                                {
                                    <tr>
                                        <td class="text-truncate" style="max-width: 280px;">@r.ContentType</td>
                                        <td class="text-end">@r.Count</td>
                                        <td class="text-end">@WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel.FormatBytes(r.Bytes)</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mt-0">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <div class="fw-semibold">Largest Active Files</div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>File</th>
                                <th class="text-end">Size</th>
                                <th class="text-end">Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.LargestActive.Count == 0)
                            {
                                <tr><td colspan="3" class="text-muted p-3">No active media.</td></tr>
                            }
                            else
                            {
                                foreach (var m in Model.LargestActive)
                                {
                                    <tr>
                                        <td class="text-truncate" style="max-width: 320px;" title="@m.FileName">@m.FileName</td>
                                        <td class="text-end">@WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel.FormatBytes(m.Bytes)</td>
                                        <td class="text-end">@m.CreatedAtUtc.ToLocalTime().ToString("yyyy-MM-dd")</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <div class="fw-semibold">Largest Deleted Files</div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>File</th>
                                <th class="text-end">Size</th>
                                <th class="text-end">Deleted</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.LargestDeleted.Count == 0)
                            {
                                <tr><td colspan="3" class="text-muted p-3">No deleted media.</td></tr>
                            }
                            else
                            {
                                foreach (var m in Model.LargestDeleted)
                                {
                                    <tr>
                                        <td class="text-truncate" style="max-width: 320px;" title="@m.FileName">@m.FileName</td>
                                        <td class="text-end">@WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel.FormatBytes(m.Bytes)</td>
                                        <td class="text-end">@((m.DeletedAtUtc?.ToLocalTime().ToString("yyyy-MM-dd")) ?? "—")</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
