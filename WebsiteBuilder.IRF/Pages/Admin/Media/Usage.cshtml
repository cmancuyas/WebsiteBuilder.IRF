@page
@model WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel
@using System.Text.Json

@{
    ViewData["Title"] = "Media Usage";

    var labels = Model.MonthlyUsage.Select(x => x.Label).ToList();
    var counts = Model.MonthlyUsage.Select(x => x.Count).ToList();
    var bytes = Model.MonthlyUsage.Select(x => x.Bytes).ToList();

    var labelsJson = JsonSerializer.Serialize(labels);
    var countsJson = JsonSerializer.Serialize(counts);
    var bytesJson = JsonSerializer.Serialize(bytes);

    var usedPercent = Model.UsedPercent;
    if (usedPercent < 0) usedPercent = 0;
    if (usedPercent > 100) usedPercent = 100;
}

<h2 class="mb-3">Media Usage</h2>

<form id="antiForgeryForm" method="post">
    @Html.AntiForgeryToken()
</form>

@if (!Model.IsTenantResolved)
{
    <div class="alert alert-warning">Tenant not resolved.</div>
    return;
}

<div class="d-flex justify-content-end mb-3">
    <button type="button" class="btn btn-outline-danger js-run-cleanup" @(Model.Eligibility.CleanupEnabled ? "" : "disabled")>
        Run cleanup now
    </button>
</div>

<div class="small text-muted mb-3" id="cleanupLastRunPanel" style="display:none;"></div>

<div class="row g-3">
    <div class="col-12 col-lg-4">
        <div class="card">
            <div class="card-body">
                <div class="fw-semibold mb-2">Storage quota</div>

                @if (Model.QuotaBytes > 0)
                {
                    <div class="d-flex justify-content-between small text-muted">
                        <span>Used: @WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel.FormatBytes(Model.Summary.ActiveBytes)</span>
                        <span>Quota: @WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel.FormatBytes(Model.QuotaBytes)</span>
                    </div>

                    <div class="progress mt-2" style="height: 10px;">
                        <div class="progress-bar" role="progressbar" style="width:@usedPercent.ToString("0.##")%"></div>
                    </div>

                    <div class="small text-muted mt-2">
                        @usedPercent.ToString("0.##")% used
                    </div>
                }
                else
                {
                    <div class="text-muted small">Quota disabled (unlimited).</div>
                }
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-8">
        <div class="card">
            <div class="card-body">
                <div class="fw-semibold mb-2">Summary</div>
                <div class="row g-2">
                    <div class="col-6 col-md-3">
                        <div class="small text-muted">Active</div>
                        <div class="fw-semibold">@Model.Summary.ActiveCount</div>
                        <div class="text-muted small">@WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel.FormatBytes(Model.Summary.ActiveBytes)</div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="small text-muted">Deleted</div>
                        <div class="fw-semibold">@Model.Summary.DeletedCount</div>
                        <div class="text-muted small">@WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel.FormatBytes(Model.Summary.DeletedBytes)</div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="small text-muted">Total</div>
                        <div class="fw-semibold">@Model.Summary.TotalCount</div>
                        <div class="text-muted small">@WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel.FormatBytes(Model.Summary.TotalBytes)</div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="small text-muted">Eligible for cleanup</div>
                        <div class="fw-semibold">@Model.Eligibility.EligibleCount</div>
                        <div class="text-muted small">@WebsiteBuilder.IRF.Pages.Admin.Media.UsageModel.FormatBytes(Model.Eligibility.EligibleBytes)</div>
                    </div>
                </div>

                <hr />

                <div class="small text-muted">
                    Cleanup enabled: <strong>@Model.Eligibility.CleanupEnabled</strong> |
                    Retention: <strong>@Model.Eligibility.RetentionDays days</strong> |
                    Next run (local): <strong>@Model.Eligibility.NextRunLocal.ToString("yyyy-MM-dd HH:mm")</strong>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-6">
        <div class="card">
            <div class="card-body">
                <div class="fw-semibold mb-2">Uploads per month</div>
                <canvas id="uploadsCountChart" height="140"></canvas>
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-6">
        <div class="card">
            <div class="card-body">
                <div class="fw-semibold mb-2">Uploaded bytes per month</div>
                <canvas id="uploadsBytesChart" height="140"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function () {
            function getToken() {
                const el = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]');
                return el ? el.value : null;
            }

            function setLastRunPanel(text) {
                const el = document.getElementById("cleanupLastRunPanel");
                if (!el) return;
                el.style.display = "block";
                el.textContent = text;
            }

            function tryLoadLastRunFromLocalStorage() {
                try {
                    const raw = localStorage.getItem("mediaCleanupLastResult");
                    if (!raw) return;

                    const obj = JSON.parse(raw);
                    if (!obj || !obj.savedAtLocal) return;

                    setLastRunPanel(
                        `Last cleanup run: ${obj.savedAtLocal}. ` +
                        `Candidates: ${obj.candidatesFound}, Records deleted: ${obj.recordsDeleted}, Files deleted: ${obj.filesDeleted}, Failures: ${obj.fileDeleteFailures}.`
                    );
                } catch {}
            }

            async function postCleanupNow() {
                const token = getToken();
                if (!token) throw new Error("Missing antiforgery token.");

                const res = await fetch("?handler=RunCleanupNow", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
                        "RequestVerificationToken": token,
                        "X-Requested-With": "XMLHttpRequest"
                    },
                    body: ""
                });

                return res;
            }

            document.addEventListener("click", async function (e) {
                const btn = e.target.closest(".js-run-cleanup");
                if (!btn) return;

                if (!confirm("Run cleanup now? This will permanently delete media beyond retention."))
                    return;

                btn.disabled = true;

                try {
                    const res = await postCleanupNow();
                    if (!res.ok) {
                        let msg = "Cleanup failed.";
                        try {
                            const data = await res.json();
                            if (data?.error) msg = data.error;
                        } catch {}
                        alert(msg);
                        return;
                    }

                    const data = await res.json();
                    const r = data?.result;

                    // Persist last run summary for admin visibility (survives reload)
                    if (r) {
                        try {
                            localStorage.setItem("mediaCleanupLastResult", JSON.stringify({
                                savedAtLocal: new Date().toLocaleString(),
                                candidatesFound: r.candidatesFound,
                                recordsDeleted: r.recordsDeleted,
                                filesDeleted: r.filesDeleted,
                                fileDeleteFailures: r.fileDeleteFailures,
                                cutoffUtc: r.cutoffUtc
                            }));
                        } catch {}
                    }

                    location.reload();
                }
                catch {
                    alert("Cleanup failed.");
                }
                finally {
                    btn.disabled = false;
                }
            });

            // Charts
            const labels = @Html.Raw(labelsJson);
            const counts = @Html.Raw(countsJson);
            const bytes = @Html.Raw(bytesJson);

            if (labels && labels.length) {
                new Chart(document.getElementById("uploadsCountChart"), {
                    type: "line",
                    data: {
                        labels: labels,
                        datasets: [{ label: "Uploads", data: counts }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                new Chart(document.getElementById("uploadsBytesChart"), {
                    type: "line",
                    data: {
                        labels: labels,
                        datasets: [{ label: "Bytes", data: bytes }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            // Last run summary
            tryLoadLastRunFromLocalStorage();
        })();
    </script>
}
