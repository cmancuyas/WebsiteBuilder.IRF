@model WebsiteBuilder.Models.PageSection
@using System.Text.Json

@{
    // Expected JSON shape:
    // { "items": [ { "mediaAssetId": 123, "url": "...", "thumbUrl": "...", "altText": "...", "fileName": "..." } ] }

    var sectionId = Model.Id;
    var saveUrl = Url.Page(null, null, new { handler = "SaveSection" }, null);

    var initialItemsJson = "[]";

    if (!string.IsNullOrWhiteSpace(Model.SettingsJson))
    {
        try
        {
            using var doc = JsonDocument.Parse(Model.SettingsJson);
            if (doc.RootElement.TryGetProperty("items", out var items) && items.ValueKind == JsonValueKind.Array)
            {
                initialItemsJson = items.GetRawText();
            }
        }
        catch
        {
            initialItemsJson = "[]";
        }
    }
}

<div class="card border-0 shadow-sm">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="fw-semibold">Gallery</div>
            <div class="small text-muted" id="save-status-@sectionId"></div>
        </div>

        <div class="d-flex gap-2 mb-2">
            <button type="button" class="btn btn-sm btn-primary" id="gallery-add-@sectionId">Add Images</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="gallery-clear-@sectionId">Clear</button>
        </div>

        <div class="mt-2 d-none" id="errors-@sectionId"></div>

        <div id="gallery-grid-@sectionId" class="row g-2 mt-2"></div>

        <div class="form-text mt-2">Auto-saves after changes.</div>
    </div>
</div>

<style>
    .gallery-thumb {
        width: 100%;
        height: 140px;
        object-fit: cover;
        border-radius: .5rem;
        border: 1px solid rgba(0,0,0,.08);
        background: #f5f5f5;
    }
</style>

<script>
    (function () {
      const sectionId = @sectionId;
      const saveUrl = "@saveUrl";

      const addBtn = document.getElementById("gallery-add-" + sectionId);
      const clearBtn = document.getElementById("gallery-clear-" + sectionId);
      const gridEl = document.getElementById("gallery-grid-" + sectionId);

      const statusEl = document.getElementById("save-status-" + sectionId);
      const errorsEl = document.getElementById("errors-" + sectionId);

      let items = @Html.Raw(initialItemsJson);

      function normalizeExistingItems() {
        items = (items || []).map(x => ({
          mediaAssetId: parseInt(x.mediaAssetId ?? x.MediaAssetId ?? x.id ?? x.Id ?? 0, 10),
          url: x.url ?? x.Url ?? "",
          thumbUrl: x.thumbUrl ?? x.ThumbUrl ?? "",
          altText: x.altText ?? x.AltText ?? "",
          fileName: x.fileName ?? x.FileName ?? ""
        })).filter(x => Number.isFinite(x.mediaAssetId) && x.mediaAssetId > 0);
      }

      function normalizePickerItem(p) {
        return {
          mediaAssetId: parseInt(p.id ?? p.Id ?? 0, 10),
          url: p.url ?? p.Url ?? p.storageKey ?? p.StorageKey ?? "",
          thumbUrl: p.thumbUrl ?? p.ThumbUrl ?? p.thumbnailUrl ?? p.ThumbnailUrl ?? "",
          altText: p.altText ?? p.AltText ?? "",
          fileName: p.fileName ?? p.FileName ?? ""
        };
      }

      function toSettingsJson() {
        return JSON.stringify({
          items: (items || []).map(x => ({
            mediaAssetId: x.mediaAssetId,
            url: x.url || "",
            thumbUrl: x.thumbUrl || "",
            altText: x.altText || "",
            fileName: x.fileName || ""
          }))
        });
      }

      function esc(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function render() {
        if (!gridEl) return;

        gridEl.innerHTML = "";

        if (!items || items.length === 0) {
          gridEl.innerHTML = `<div class="text-muted small">No images selected yet.</div>`;
          return;
        }

        items.forEach((it, idx) => {
          const col = document.createElement("div");
          col.className = "col-6 col-md-4";

          const thumb = it.thumbUrl || it.url || "";

          col.innerHTML = `
            <div class="border rounded p-2 h-100">
              <img class="gallery-thumb" src="${esc(thumb)}" alt="${esc(it.altText || it.fileName || "")}">
              <div class="small text-muted mt-2">${esc(it.fileName || ("MediaAssetId: " + it.mediaAssetId))}</div>
              <div class="d-flex justify-content-end mt-2">
                <button type="button" class="btn btn-sm btn-outline-danger" data-action="remove">Remove</button>
              </div>
            </div>
          `;

          col.querySelector('[data-action="remove"]').addEventListener("click", () => {
            items.splice(idx, 1);
            render();
            autosave.notifyChanged();
          });

          gridEl.appendChild(col);
        });
      }

      // Autosave binding (with retry like TextEditor)
      let autosave = null;

      function init() {
        if (!addBtn || !clearBtn || !gridEl) return true;

        if (!window.SectionAutoSave || !window.SectionAutoSave.bindSectionAutoSave) return false;

        autosave = window.SectionAutoSave.bindSectionAutoSave(
          sectionId,
          () => toSettingsJson(),
          saveUrl,
          statusEl,
          errorsEl
        );

        addBtn.addEventListener("click", () => {
          if (!window.MediaPicker || typeof window.MediaPicker.open !== "function") {
            if (statusEl) {
              statusEl.textContent = "Media picker is not available.";
              statusEl.classList.add("text-danger");
            }
            return;
          }

          window.MediaPicker.open({
            multiple: true,
            onSelect: (selected) => {
              const incoming = (selected || []).map(normalizePickerItem).filter(x => x.mediaAssetId > 0);

              const existing = new Set(items.map(x => x.mediaAssetId));
              incoming.forEach(x => {
                if (!existing.has(x.mediaAssetId)) {
                  items.push(x);
                  existing.add(x.mediaAssetId);
                }
              });

              render();
              autosave.notifyChanged();
            }
          });
        });

        clearBtn.addEventListener("click", () => {
          items = [];
          render();
          autosave.notifyChanged();
        });

        normalizeExistingItems();
        render();
        return true;
      }

      if (init()) return;

      let tries = 0;
      const t = setInterval(() => {
        tries++;
        if (init() || tries > 20) clearInterval(t);
      }, 100);
    })();
</script>
