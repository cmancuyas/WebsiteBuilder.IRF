@page
@model WebsiteBuilder.IRF.Pages.Admin.Pages.Sections.CreateModel

@{
    ViewData["Title"] = "Add Section";
}

<h2 class="mb-3">Add Section</h2>

<form method="post">
    <input type="hidden" asp-for="Section.PageId" />
    <input type="hidden" asp-for="Section.SortOrder" />

    <div class="mb-3">
        <label class="form-label">Section Type</label>
        <select class="form-select" asp-for="Section.SectionTypeId" asp-items="Model.SectionTypeOptions" id="sectionTypeId"></select>
        <span class="text-danger" asp-validation-for="Section.SectionTypeId"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">SettingsJson</label>
        <textarea class="form-control font-monospace" rows="10" asp-for="Section.SettingsJson" id="settingsJson"></textarea>
        <span class="text-danger" asp-validation-for="Section.SettingsJson"></span>
        <div class="form-text">Must be valid JSON object, e.g. <code>{}</code></div>
    </div>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">Save</button>
        <a class="btn btn-outline-secondary" asp-page="/Admin/Pages/Sections" asp-route-id="@Model.Section.PageId">Cancel</a>
    </div>
</form>

@section Scripts
{
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            const ddl = document.getElementById('sectionTypeId');
            const txt = document.getElementById('settingsJson');

            if (!ddl || !txt) return;

            let timer = null;

            function validateNow() {
                const sectionTypeId = ddl.value;
                const settingsJson = txt.value;

                const formData = new FormData();
                formData.append('sectionTypeId', sectionTypeId);
                formData.append('settingsJson', settingsJson);

                fetch('?handler=ValidateJson', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: formData
                })
                .then(r => r.json())
                .then(res => {
                    // You can wire this into a nicer UI later (inline list, etc.).
                    // For now, we only log errors to console to avoid spammy alerts.
                    if (!res.isValid && res.errors && res.errors.length) {
                        console.warn('Section JSON invalid:', res.errors);
                    }
                })
                .catch(err => console.error(err));
            }

            ddl.addEventListener('change', function () {
                // After changing type, validate the current payload against new type
                validateNow();
            });

            txt.addEventListener('input', function () {
                clearTimeout(timer);
                timer = setTimeout(validateNow, 300);
            });

            function getAntiForgeryToken() {
                const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                return tokenInput ? tokenInput.value : '';
            }
        })();
    </script>

    @* Hidden antiforgery token for fetch() *@
    <form method="post" style="display:none;">
        @Html.AntiForgeryToken()
    </form>

    <style>
        .font-monospace {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
    </style>
}
