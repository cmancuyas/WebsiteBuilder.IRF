@page
@model WebsiteBuilder.IRF.Pages.Admin.Pages.SectionsModel
@{
    ViewData["Title"] = "Manage Sections";
    var pageId = Model.Id;
}

<div class="container py-4">

    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h3 class="mb-1">Sections</h3>
            <div class="text-muted">
                <strong>@Model.PageTitle</strong>
                @if (!string.IsNullOrWhiteSpace(Model.PageSlug))
                {
                    <span class="ms-2">/@Model.PageSlug</span>
                }
            </div>
        </div>

        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" asp-page="/Admin/Pages/Edit" asp-route-id="@pageId">Back to Page</a>
            <a class="btn btn-outline-primary" href="/@Model.PageSlug?preview=true" target="_blank">Preview</a>
        </div>
    </div>

    @* TempData messages *@
    @if (TempData["Ok"] is string okMsg && !string.IsNullOrWhiteSpace(okMsg))
    {
        <div class="alert alert-success">@okMsg</div>
    }
    @if (TempData["Err"] is string errMsg && !string.IsNullOrWhiteSpace(errMsg))
    {
        <div class="alert alert-danger">@errMsg</div>
    }

    @* Add Section *@
    <div class="card mb-3">
        <div class="card-header">
            Add Section
        </div>
        <div class="card-body">
            <form method="post" asp-page-handler="Add" asp-route-pageId="@pageId">
                @Html.AntiForgeryToken()

                <div class="row g-2 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">Section Type</label>
                        <select class="form-select" asp-for="NewSectionTypeId" asp-items="Model.SectionTypeOptions">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </div>

                <span class="text-danger" asp-validation-for="NewSectionTypeId"></span>
            </form>
        </div>
    </div>

    @* Sections List *@
    <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
            <span>Current Sections</span>
            <small class="text-muted">Drag rows to reorder</small>
        </div>

        <div class="card-body p-0">
            @if (Model.Sections == null || Model.Sections.Count == 0)
            {
                <div class="p-3">
                    <div class="alert alert-warning mb-0">No sections yet. Add one above.</div>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th style="width:48px;"></th>
                                <th style="width:90px;">Order</th>
                                <th style="width:220px;">Type</th>
                                <th>JSON</th>
                                <th style="width:180px;" class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sectionsTbody">
                            @foreach (var s in Model.Sections)
                            {
                                <tr data-section-id="@s.Id">
                                    <td class="text-muted" style="cursor:grab;" title="Drag to reorder">⋮⋮</td>
                                    <td>@s.SortOrder</td>
                                    <td>@s.SectionTypeName</td>
                                    <td>
                                        <pre class="mb-0" style="white-space:pre-wrap;max-height:140px;overflow:auto;">@s.SettingsJson</pre>
                                    </td>
                                    <td class="text-end">
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary"
                                                onclick="openEdit(@s.Id, @s.SectionTypeId, @Html.Raw(System.Text.Json.JsonSerializer.Serialize(s.SettingsJson)))">
                                            Edit
                                        </button>

                                        <form method="post"
                                              class="d-inline"
                                              asp-page-handler="Delete"
                                              asp-route-pageId="@pageId"
                                              asp-route-sectionId="@s.Id"
                                              onsubmit="return confirm('Delete this section?');">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@* Edit Modal *@
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <form method="post" asp-page-handler="Update" asp-route-pageId="@pageId">
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title">Edit Section</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" asp-for="Edit.Id" />

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Type</label>
                            <select class="form-select" asp-for="Edit.SectionTypeId" asp-items="Model.SectionTypeOptions"></select>
                            <span class="text-danger" asp-validation-for="Edit.SectionTypeId"></span>
                        </div>

                        <div class="col-md-8">
                            <label class="form-label">Settings JSON</label>
                            <textarea class="form-control" asp-for="Edit.SettingsJson" rows="14" spellcheck="false"></textarea>
                            <span class="text-danger" asp-validation-for="Edit.SettingsJson"></span>
                            <small class="text-muted d-block mt-1">Must be valid JSON for the selected type.</small>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>

            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // ------------------------------
        // Edit modal helper
        // ------------------------------
        function openEdit(id, sectionTypeId, settingsJson) {
            // settingsJson arrives as a JSON string; normalize for textarea
            const jsonText = (typeof settingsJson === "string") ? settingsJson : JSON.stringify(settingsJson, null, 2);

            document.querySelector('[name="Edit.Id"]').value = id;
            document.querySelector('[name="Edit.SectionTypeId"]').value = sectionTypeId;
            document.querySelector('[name="Edit.SettingsJson"]').value = jsonText;

            const modalEl = document.getElementById('editModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
        }

        // ------------------------------
        // Reorder (AJAX) with anti-forgery
        // ------------------------------
        function getAntiForgeryToken() {
            // Razor Pages antiforgery token input is rendered by @Html.AntiForgeryToken()
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            return tokenInput ? tokenInput.value : "";
        }

        async function postReorder(orderedIds) {
            const pageId = @pageId;

            const resp = await fetch(`?handler=Reorder&pageId=${pageId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": getAntiForgeryToken()
                },
                body: JSON.stringify({ orderedIds })
            });

            if (!resp.ok) {
                console.error("Reorder failed:", resp.status);
                return;
            }

            const data = await resp.json().catch(() => null);
            if (!data || data.ok !== true) {
                console.error("Reorder response not ok:", data);
            }
        }

        // Minimal drag/drop (HTML5) - production-safe baseline
        // If you already use SortableJS, replace this with your existing integration
        (function initReorder() {
            const tbody = document.getElementById("sectionsTbody");
            if (!tbody) return;

            let draggingRow = null;

            tbody.querySelectorAll("tr").forEach(row => {
                row.draggable = true;

                row.addEventListener("dragstart", e => {
                    draggingRow = row;
                    row.classList.add("table-warning");
                    e.dataTransfer.effectAllowed = "move";
                });

                row.addEventListener("dragend", () => {
                    if (draggingRow) draggingRow.classList.remove("table-warning");
                    draggingRow = null;

                    // After drag ends, compute order and POST
                    const orderedIds = Array.from(tbody.querySelectorAll("tr"))
                        .map(r => parseInt(r.getAttribute("data-section-id"), 10))
                        .filter(n => !isNaN(n));

                    postReorder(orderedIds);
                });

                row.addEventListener("dragover", e => {
                    e.preventDefault();
                    const target = e.currentTarget;
                    if (!draggingRow || target === draggingRow) return;

                    const rect = target.getBoundingClientRect();
                    const next = (e.clientY - rect.top) > (rect.height / 2);
                    tbody.insertBefore(draggingRow, next ? target.nextSibling : target);
                });
            });
        })();
    </script>
}
