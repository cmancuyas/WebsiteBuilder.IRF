@page
@model WebsiteBuilder.IRF.Pages.Admin.Navigation.IndexModel
@using Microsoft.AspNetCore.Html
@using WebsiteBuilder.Models.Constants

@{
    ViewData["Title"] = "Navigation Builder";
}

<div class="container py-4">

    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h2 class="mb-0">Navigation Builder</h2>
            <div class="text-muted small">Manage site navigation configuration.</div>
        </div>

        <a class="btn btn-outline-secondary" asp-page="/Admin/Pages/Index">Back to Pages</a>
    </div>

    <div id="navMsg" class="mb-3"></div>

    <ul class="nav nav-tabs" id="navBuilderTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active"
                    id="tab-pages"
                    data-bs-toggle="tab"
                    data-bs-target="#pane-pages"
                    type="button"
                    role="tab">
                Pages
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link"
                    id="tab-menuitems"
                    data-bs-toggle="tab"
                    data-bs-target="#pane-menuitems"
                    type="button"
                    role="tab">
                Menu Items (DB)
            </button>
        </li>
    </ul>

    <div class="tab-content border border-top-0 rounded-bottom shadow-sm" id="navBuilderTabContent">

        <!-- TAB A: Pages (keep your existing UI here as-is) -->
        <div class="tab-pane fade show active p-0" id="pane-pages" role="tabpanel">
            <!-- KEEP YOUR EXISTING PAGES TABLE + SORTABLE SCRIPT (unchanged) -->
            @* (Your current Pages tab content remains here.) *@
        </div>

        <!-- TAB B: NavigationMenuItems -->
        <div class="tab-pane fade p-3" id="pane-menuitems" role="tabpanel">

            <div class="d-flex align-items-start justify-content-between mb-2">
                <div>
                    <strong>NavigationMenuItems</strong>
                    <div class="text-muted small">
                        Draft working set (Step 2). Header/Footer supported.
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary btn-sm" id="btnAddMenuItem">
                        Add Menu Item
                    </button>
                    <span class="badge bg-light text-dark align-self-center">
                        Total: @Model.MenuItemsFlat.Count
                    </span>
                </div>
            </div>

            @if (Model.MenuItemsFlat.Count == 0)
            {
                <div class="alert alert-warning mb-0">
                    No navigation menu items found for this tenant.
                </div>
            }
            else
            {
                <div class="row g-3">
                    <div class="col-12 col-lg-6">
                        <div class="card">
                            <div class="card-header"><strong>Tree</strong></div>
                            <div class="card-body">
                                @foreach (var menu in WebsiteBuilder.IRF.Pages.Admin.Navigation.IndexModel.MenuNames.OrderBy(x => x.Key))
                                {
                                    var menuId = menu.Key;
                                    var menuName = menu.Value;

                                    <div class="mb-3">
                                        <div class="fw-semibold mb-2">@menuName</div>

                                        @if (Model.MenuTreesByMenuId.TryGetValue(menuId, out var roots) && roots.Count > 0)
                                        {
                                            @RenderNodes(roots)
                                        }
                                        else
                                        {
                                            <div class="text-muted small">No items.</div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-lg-6">
                        <div class="card">
                            <div class="card-header"><strong>Flat (ordered)</strong></div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0" id="menuItemsTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 36px;"></th>
                                                <th style="width: 90px;">Menu</th>
                                                <th style="width: 80px;">Parent</th>
                                                <th style="width: 70px;">Sort</th>
                                                <th>Label</th>
                                                <th style="width: 90px;">PageId</th>
                                                <th style="width: 90px;">New Tab</th>
                                                <th style="width: 120px;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var mi in Model.MenuItemsFlat)
                                            {
                                                var menuName = Model.MenuNamesMap.TryGetValue(mi.MenuId, out var n) ? n : $"Menu {mi.MenuId}";
                                                <tr data-id="@mi.Id"
                                                    data-menuid="@mi.MenuId"
                                                    data-parentid="@(mi.ParentId?.ToString() ?? "")"
                                                    data-label="@mi.Label"
                                                    data-pageid="@(mi.PageId?.ToString() ?? "")"
                                                    data-url="@mi.Url"
                                                    data-newtab="@(mi.OpenInNewTab ? "1" : "0")">
                                                    <td class="text-muted drag-handle" style="cursor: grab;">☰</td>
                                                    <td>@menuName</td>
                                                    <td>@(mi.ParentId?.ToString() ?? "-")</td>
                                                    <td>@mi.SortOrder</td>
                                                    <td class="fw-semibold">@mi.Label</td>
                                                    <td>@(mi.PageId?.ToString() ?? "-")</td>
                                                    <td>@(mi.OpenInNewTab ? "Yes" : "No")</td>
                                                    <td>
                                                        <button type="button" class="btn btn-outline-primary btn-sm btnEditMenuItem">Edit</button>
                                                        <button type="button" class="btn btn-outline-danger btn-sm btnDeleteMenuItem">Delete</button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer text-muted small">
                                Reordering comes in Step 3 (drag & drop).
                            </div>
                        </div>
                    </div>
                </div>
            }

        </div>
    </div>
</div>

<!-- Modal: Add/Edit Menu Item -->
<div class="modal fade" id="menuItemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="menuItemModalTitle">Menu Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="alert alert-danger d-none" id="menuItemError"></div>

                <input type="hidden" id="miId" />

                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label">Menu</label>
                        <select class="form-select" id="miMenuId">
                            <option value="1">Header</option>
                            <option value="2">Footer</option>
                        </select>
                    </div>

                    <div class="col-12 col-md-6">
                        <label class="form-label">Parent (optional)</label>
                        <select class="form-select" id="miParentId">
                            <option value="">(No parent)</option>
                        </select>
                        <div class="form-text">Only items within the selected menu can be parents.</div>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Label</label>
                        <input class="form-control" id="miLabel" maxlength="200" />
                    </div>

                    <div class="col-12 col-md-6">
                        <label class="form-label">Link type</label>
                        <select class="form-select" id="miLinkType">
                            <option value="internal">Internal page (Published)</option>
                            <option value="external">External URL</option>
                        </select>
                    </div>

                    <div class="col-12 col-md-6 d-flex align-items-end">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="miNewTab">
                            <label class="form-check-label" for="miNewTab">Open in new tab</label>
                        </div>
                    </div>

                    <div class="col-12" id="miInternalWrap">
                        <label class="form-label">Published page</label>
                        <select class="form-select" id="miPageId">
                            <option value="">Select a page...</option>
                            @foreach (var p in Model.PublishedPages)
                            {
                                <option value="@p.Id">@p.Title (@("/" + (p.Slug ?? "").Trim('/')))</option>
                            }
                        </select>
                    </div>

                    <div class="col-12 d-none" id="miExternalWrap">
                        <label class="form-label">External URL</label>
                        <input class="form-control" id="miUrl" maxlength="500" placeholder="https://example.com" />
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnSaveMenuItem">Save</button>
            </div>
        </div>
    </div>
</div>

@functions {
    private IHtmlContent RenderNodes(IEnumerable<WebsiteBuilder.IRF.Pages.Admin.Navigation.IndexModel.NavNode> nodes)
    {
        var ul = new TagBuilder("ul");
        ul.AddCssClass("list-unstyled mb-0");

        foreach (var n in nodes)
        {
            var li = new TagBuilder("li");
            li.AddCssClass("mb-2");

            var header = new TagBuilder("div");
            header.AddCssClass("d-flex align-items-start gap-2");

            var badge = new TagBuilder("span");
            badge.AddCssClass("badge bg-light text-dark");
            badge.InnerHtml.Append($"M{n.Item.MenuId} · S{n.Item.SortOrder}");

            var text = new TagBuilder("div");
            text.AddCssClass("flex-grow-1");

            var line1 = new TagBuilder("div");
            line1.InnerHtml.Append(n.Item.Label);

            text.InnerHtml.AppendHtml(line1);

            header.InnerHtml.AppendHtml(badge);
            header.InnerHtml.AppendHtml(text);

            li.InnerHtml.AppendHtml(header);

            if (n.Children.Count > 0)
            {
                var childWrap = new TagBuilder("div");
                childWrap.AddCssClass("ms-4 mt-2");
                childWrap.InnerHtml.AppendHtml(RenderNodes(n.Children));
                li.InnerHtml.AppendHtml(childWrap);
            }

            ul.InnerHtml.AppendHtml(li);
        }

        return ul;
    }
}

@section Scripts
{
    @Html.AntiForgeryToken()

    <script>
        (function () {
            const tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenEl ? tokenEl.value : null;

            const modalEl = document.getElementById("menuItemModal");
            const modal = modalEl ? new bootstrap.Modal(modalEl) : null;

            const errBox = document.getElementById("menuItemError");

            const miId = document.getElementById("miId");
            const miMenuId = document.getElementById("miMenuId");
            const miParentId = document.getElementById("miParentId");
            const miLabel = document.getElementById("miLabel");
            const miLinkType = document.getElementById("miLinkType");
            const miPageId = document.getElementById("miPageId");
            const miUrl = document.getElementById("miUrl");
            const miNewTab = document.getElementById("miNewTab");

            const wrapInternal = document.getElementById("miInternalWrap");
            const wrapExternal = document.getElementById("miExternalWrap");

            function showError(msg) {
                if (!errBox) return;
                if (!msg) {
                    errBox.classList.add("d-none");
                    errBox.textContent = "";
                    return;
                }
                errBox.classList.remove("d-none");
                errBox.textContent = msg;
            }

            function setLinkTypeUI() {
                const t = (miLinkType.value || "").toLowerCase();
                if (t === "external") {
                    wrapExternal.classList.remove("d-none");
                    wrapInternal.classList.add("d-none");
                } else {
                    wrapInternal.classList.remove("d-none");
                    wrapExternal.classList.add("d-none");
                }
            }

            function rebuildParentOptions(selectedMenuId, excludeId) {
                // Parents are limited to items in the same menu
                const rows = document.querySelectorAll("#menuItemsTable tbody tr");
                miParentId.innerHTML = '<option value="">(No parent)</option>';

                rows.forEach(r => {
                    const id = r.getAttribute("data-id");
                    const menuId = r.getAttribute("data-menuid");
                    const label = r.getAttribute("data-label") || "";

                    if (menuId !== String(selectedMenuId)) return;
                    if (excludeId && id === String(excludeId)) return;

                    const opt = document.createElement("option");
                    opt.value = id;
                    opt.textContent = `${label} (Id: ${id})`;
                    miParentId.appendChild(opt);
                });
            }

            async function postJson(url, payload) {
                const res = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        ...(token ? { "RequestVerificationToken": token } : {})
                    },
                    body: JSON.stringify(payload)
                });
                return await res.json();
            }

            function openForCreate() {
                showError(null);
                document.getElementById("menuItemModalTitle").textContent = "Add Menu Item";

                miId.value = "";
                miMenuId.value = "1";
                miLabel.value = "";
                miLinkType.value = "internal";
                miPageId.value = "";
                miUrl.value = "";
                miNewTab.checked = false;

                rebuildParentOptions(1, null);
                miParentId.value = "";

                setLinkTypeUI();
                modal.show();
            }

            function openForEdit(row) {
                showError(null);
                document.getElementById("menuItemModalTitle").textContent = "Edit Menu Item";

                const id = row.getAttribute("data-id");
                const menuId = row.getAttribute("data-menuid") || "1";
                const parentId = row.getAttribute("data-parentid") || "";
                const label = row.getAttribute("data-label") || "";
                const pageId = row.getAttribute("data-pageid") || "";
                const url = row.getAttribute("data-url") || "";
                const newtab = row.getAttribute("data-newtab") === "1";

                miId.value = id;
                miMenuId.value = menuId;
                miLabel.value = label;
                miNewTab.checked = newtab;

                // Determine link type: internal if PageId set, otherwise external
                if (pageId) {
                    miLinkType.value = "internal";
                    miPageId.value = pageId;
                    miUrl.value = "";
                } else {
                    miLinkType.value = "external";
                    miUrl.value = url;
                    miPageId.value = "";
                }

                rebuildParentOptions(menuId, id);
                miParentId.value = parentId;

                setLinkTypeUI();
                modal.show();
            }

            async function saveMenuItem() {
                showError(null);

                const payload = {
                    id: miId.value ? parseInt(miId.value, 10) : null,
                    menuId: parseInt(miMenuId.value, 10),
                    parentId: miParentId.value ? parseInt(miParentId.value, 10) : null,
                    label: miLabel.value || "",
                    linkType: miLinkType.value || "",
                    pageId: miPageId.value ? parseInt(miPageId.value, 10) : null,
                    url: miUrl.value || "",
                    openInNewTab: !!miNewTab.checked
                };

                const result = await postJson("?handler=UpsertMenuItem", payload);
                if (!result.ok) {
                    showError(result.message || "Save failed.");
                    return;
                }

                // simplest approach: reload so tree/flat refresh
                window.location.reload();
            }

            async function deleteMenuItem(row) {
                const id = parseInt(row.getAttribute("data-id"), 10);
                if (!id) return;

                if (!confirm("Delete this menu item?")) return;

                const result = await postJson("?handler=DeleteMenuItem", { id });
                if (!result.ok) {
                    alert(result.message || "Delete failed.");
                    return;
                }

                window.location.reload();
            }

            // Events
            document.getElementById("btnAddMenuItem")?.addEventListener("click", openForCreate);
            document.getElementById("btnSaveMenuItem")?.addEventListener("click", saveMenuItem);

            miLinkType?.addEventListener("change", setLinkTypeUI);

            miMenuId?.addEventListener("change", function () {
                const id = miId.value ? parseInt(miId.value, 10) : null;
                rebuildParentOptions(parseInt(miMenuId.value, 10), id);
                miParentId.value = "";
            });

            document.querySelectorAll(".btnEditMenuItem").forEach(btn => {
                btn.addEventListener("click", function () {
                    const row = btn.closest("tr");
                    if (row) openForEdit(row);
                });
            });

            document.querySelectorAll(".btnDeleteMenuItem").forEach(btn => {
                btn.addEventListener("click", function () {
                    const row = btn.closest("tr");
                    if (row) deleteMenuItem(row);
                });
            });

            setLinkTypeUI();
        })();

        (function () {
            const tableBody = document.querySelector("#menuItemsTable tbody");
            if (!tableBody) return;

            new Sortable(tableBody, {
                handle: ".drag-handle",
                animation: 150,
                ghostClass: "bg-light",
                onEnd: function (evt) {
                    const row = evt.item;
                    const prev = row.previousElementSibling;

                    const moved = {
                        id: parseInt(row.dataset.id),
                        menuId: parseInt(row.dataset.menuid),
                        parentId: row.dataset.parentid ? parseInt(row.dataset.parentid) : null,
                        afterId: prev ? parseInt(prev.dataset.id) : null
                    };

                    saveReorder(moved);
                }
            });

            async function saveReorder(payload) {
                const res = await fetch("?handler=ReorderMenuItem", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();
                if (!result.ok) {
                    alert(result.message || "Reorder failed.");
                    window.location.reload();
                }
            }
        })();

    </script>
}
