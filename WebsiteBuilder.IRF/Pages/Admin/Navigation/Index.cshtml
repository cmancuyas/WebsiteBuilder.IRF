@page "/admin/navigation"
@model WebsiteBuilder.IRF.Pages.Admin.Navigation.IndexModel

@using Microsoft.AspNetCore.Html
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["Title"] = "Navigation Builder";

    string MenuName(int menuId) => menuId switch
    {
        1 => "Header",
        2 => "Footer",
        _ => $"Menu {menuId}"
    };
}

<div class="d-flex align-items-start justify-content-between mb-3">
    <div>
        <h1 class="h3 mb-1">Navigation Builder</h1>
        <div class="text-muted">Manage site navigation configuration.</div>
    </div>
    <div>
        <a class="btn btn-outline-secondary" href="/admin/pages">Back to Pages</a>
    </div>
</div>

<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link" href="/admin/navigation">Menu Items (DB)</a>
    </li>
</ul>

<div class="card">
    <div class="card-body">

        <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
                <div class="fw-semibold">NavigationMenuItems</div>
                <div class="text-muted small">Draft working set (Step 2). Header/Footer supported.</div>
            </div>

            <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-primary btn-sm" id="btnAddMenuItem">Add Menu Item</button>
                <span class="badge bg-light text-dark border">Total: @Model.MenuItemsFlat.Count</span>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-12 col-lg-6">
                <div class="card h-100">
                    <div class="card-header"><strong>Tree</strong></div>
                    <div class="card-body">

                        @foreach (var menuId in new[] { 1, 2 })
                        {
                            <div class="mb-3">
                                <div class="fw-semibold mb-2">@MenuName(menuId)</div>
                                @{                         
                                var rootNodes = Model.TreesByMenu.TryGetValue(menuId, out var r)
                                ? r
                                : Array.Empty<WebsiteBuilder.IRF.Pages.Admin.Navigation.IndexModel.NavNode>
                                    ();

                                    if (!rootNodes.Any())
                                    {
                                    <div class="text-muted small">No items.</div>
                                    }
                                    else
                                    {
                                    @RenderNodes(rootNodes, menuId, 0)
                                    }
                                }
                            </div>
                        }

                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6">
                <div class="card h-100">
                    <div class="card-header"><strong>Flat (ordered)</strong></div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0" id="menuItemsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 30px;"></th>
                                        <th style="width: 90px;">Menu</th>
                                        <th style="width: 80px;">Parent</th>
                                        <th style="width: 70px;">Sort</th>
                                        <th>Label</th>
                                        <th style="width: 90px;">PageId</th>
                                        <th style="width: 90px;">New Tab</th>
                                        <th style="width: 140px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var mi in Model.MenuItemsFlat)
                                    {
                                        var menuName = MenuName(mi.MenuId);

                                        <tr data-id="@mi.Id"
                                            data-menuid="@mi.MenuId"
                                            data-parentid="@(mi.ParentId?.ToString() ?? "")"
                                            data-label="@mi.Label"
                                            data-pageid="@(mi.PageId?.ToString() ?? "")"
                                            data-url="@mi.Url"
                                            data-newtab="@(mi.OpenInNewTab ? "1" : "0")">

                                            <td class="text-muted" title="Drag to reorder">
                                                <span class="drag-handle" style="cursor: grab;">☰</span>
                                            </td>
                                            <td>@menuName</td>
                                            <td>@(mi.ParentId?.ToString() ?? "-")</td>
                                            <td>@mi.SortOrder</td>
                                            <td class="fw-semibold">@mi.Label</td>
                                            <td>@(mi.PageId?.ToString() ?? "-")</td>
                                            <td>@(mi.OpenInNewTab ? "Yes" : "No")</td>
                                            <td>
                                                <button type="button" class="btn btn-outline-primary btn-sm btnEditMenuItem">Edit</button>
                                                <button type="button" class="btn btn-outline-danger btn-sm btnDeleteMenuItem">Delete</button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer text-muted small">
                        Reordering comes in Step 3 (drag &amp; drop).
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="menuItemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="menuItemModalTitle">Add Menu Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="alert alert-danger d-none" id="menuItemError"></div>

                <input type="hidden" id="miId" />

                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label">Menu</label>
                        <select class="form-select" id="miMenuId">
                            <option value="1">Header</option>
                            <option value="2">Footer</option>
                        </select>
                    </div>

                    <div class="col-12 col-md-6">
                        <label class="form-label">Parent (optional)</label>
                        <select class="form-select" id="miParentId">
                            <option value="">(none)</option>
                        </select>
                        <div class="text-muted small mt-1">Only items within the selected menu can be parents.</div>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Label</label>
                        <input class="form-control" id="miLabel" maxlength="100" />
                    </div>

                    <div class="col-12 col-md-6">
                        <label class="form-label">Link type</label>
                        <select class="form-select" id="miLinkType">
                            <option value="internal">Internal page (Published)</option>
                            <option value="external">External URL</option>
                        </select>
                    </div>

                    <div class="col-12 col-md-6 d-flex align-items-end">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="miNewTab" />
                            <label class="form-check-label" for="miNewTab">Open in new tab</label>
                        </div>
                    </div>

                    <div class="col-12" id="miInternalWrap">
                        <label class="form-label">Published page</label>
                        <select class="form-select" id="miPageId">
                            <option value="">(select)</option>
                            @foreach (var p in Model.PublishedPages)
                            {
                                <option value="@p.Id">@p.Title (@(string.IsNullOrWhiteSpace(p.Slug) ? "-" : "/" + p.Slug))</option>
                            }
                        </select>
                    </div>

                    <div class="col-12 d-none" id="miExternalWrap">
                        <label class="form-label">URL</label>
                        <input class="form-control" id="miUrl" placeholder="https://example.com or /contact" />
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" type="button" id="btnSaveMenuItem">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

    <script>
        (function () {
            const modalEl = document.getElementById('menuItemModal');
            const modal = new bootstrap.Modal(modalEl);

            const errBox = document.getElementById('menuItemError');

            const miId = document.getElementById('miId');
            const miMenuId = document.getElementById('miMenuId');
            const miParentId = document.getElementById('miParentId');
            const miLabel = document.getElementById('miLabel');
            const miLinkType = document.getElementById('miLinkType');
            const miNewTab = document.getElementById('miNewTab');
            const miPageId = document.getElementById('miPageId');
            const miUrl = document.getElementById('miUrl');

            const internalWrap = document.getElementById('miInternalWrap');
            const externalWrap = document.getElementById('miExternalWrap');

            function showError(msg) {
                errBox.textContent = msg || '';
                errBox.classList.toggle('d-none', !msg);
            }

            function setLinkTypeUi() {
                const v = (miLinkType.value || '').toLowerCase();
                internalWrap.classList.toggle('d-none', v !== 'internal');
                externalWrap.classList.toggle('d-none', v !== 'external');
            }

            function collectParentsForMenu(menuId, excludeId) {
                const rows = Array.from(document.querySelectorAll('#menuItemsTable tbody tr'));
                const items = rows
                    .map(r => ({
                        id: parseInt(r.dataset.id, 10),
                        menuId: parseInt(r.dataset.menuid, 10),
                        label: r.dataset.label || '',
                    }))
                    .filter(x => x.menuId === menuId && x.id !== excludeId);

                miParentId.innerHTML = '<option value="">(none)</option>';
                for (const it of items) {
                    const opt = document.createElement('option');
                    opt.value = String(it.id);
                    opt.textContent = it.label + ` (Id: ${it.id})`;
                    miParentId.appendChild(opt);
                }
            }

            function openAdd() {
                document.getElementById('menuItemModalTitle').textContent = 'Add Menu Item';
                showError('');

                miId.value = '';
                miMenuId.value = '1';
                miLabel.value = '';
                miLinkType.value = 'internal';
                miNewTab.checked = false;
                miPageId.value = '';
                miUrl.value = '';
                collectParentsForMenu(1, -1);
                miParentId.value = '';
                setLinkTypeUi();

                modal.show();
            }

            function openEdit(row) {
                document.getElementById('menuItemModalTitle').textContent = 'Edit Menu Item';
                showError('');

                const id = parseInt(row.dataset.id, 10);

                miId.value = String(id);
                miMenuId.value = row.dataset.menuid || '1';
                miLabel.value = row.dataset.label || '';
                miNewTab.checked = (row.dataset.newtab === '1');

                const hasPage = !!row.dataset.pageid;
                miLinkType.value = hasPage ? 'internal' : 'external';

                miPageId.value = row.dataset.pageid || '';
                miUrl.value = row.dataset.url || '';

                const menuId = parseInt(miMenuId.value, 10);
                collectParentsForMenu(menuId, id);
                miParentId.value = row.dataset.parentid || '';

                setLinkTypeUi();
                modal.show();
            }

            async function postJson(url, payload) {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value ?? ''
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json().catch(() => null);
                return { ok: res.ok, data };
            }

            async function saveItem() {
                showError('');

                const payload = {
                    id: miId.value ? parseInt(miId.value, 10) : null,
                    menuId: parseInt(miMenuId.value, 10),
                    parentId: miParentId.value ? parseInt(miParentId.value, 10) : null,
                    label: miLabel.value,
                    linkType: miLinkType.value,
                    pageId: miLinkType.value === 'internal' ? (miPageId.value ? parseInt(miPageId.value, 10) : null) : null,
                    url: miLinkType.value === 'external' ? miUrl.value : null,
                    openInNewTab: !!miNewTab.checked
                };

                const r = await postJson('?handler=UpsertMenuItem', payload);
                if (!r.ok || !r.data?.ok) {
                    showError(r.data?.message || 'Save failed.');
                    return;
                }

                location.reload();
            }

            async function deleteItem(id) {
                if (!confirm('Delete this menu item?')) return;

                const r = await postJson('?handler=DeleteMenuItem', { id: id });
                if (!r.ok || !r.data?.ok) {
                    alert(r.data?.message || 'Delete failed.');
                    return;
                }
                location.reload();
            }

            // Wire UI
            document.getElementById('btnAddMenuItem').addEventListener('click', openAdd);
            document.getElementById('btnSaveMenuItem').addEventListener('click', saveItem);

            miLinkType.addEventListener('change', setLinkTypeUi);
            miMenuId.addEventListener('change', function () {
                const id = miId.value ? parseInt(miId.value, 10) : -1;
                const menuId = parseInt(miMenuId.value, 10);
                collectParentsForMenu(menuId, id);
            });

            document.querySelectorAll('.btnEditMenuItem').forEach(btn => {
                btn.addEventListener('click', function () {
                    openEdit(btn.closest('tr'));
                });
            });

            document.querySelectorAll('.btnDeleteMenuItem').forEach(btn => {
                btn.addEventListener('click', function () {
                    const row = btn.closest('tr');
                    const id = parseInt(row.dataset.id, 10);
                    deleteItem(id);
                });
            });

            // Step 3: drag & drop reorder (flat list)
            const tableBody = document.querySelector('#menuItemsTable tbody');
            if (tableBody && window.Sortable) {
                Sortable.create(tableBody, {
                    handle: '.drag-handle',
                    animation: 150,
                    onEnd: async function () {
                        // build ordered list per menu+parent grouping
                        const rows = Array.from(tableBody.querySelectorAll('tr'));
                        const items = rows.map((r, index) => ({
                            id: parseInt(r.dataset.id, 10),
                            menuId: parseInt(r.dataset.menuid, 10),
                            parentId: r.dataset.parentid ? parseInt(r.dataset.parentid, 10) : null,
                            sortOrder: index + 1
                        }));

                        const r = await postJson('?handler=ReorderMenuItems', { items });
                        if (!r.ok || !r.data?.ok) {
                            alert(r.data?.message || 'Reorder failed.');
                            return;
                        }

                        location.reload();
                    }
                });
            }
        })();
    </script>
}

@functions {
    IHtmlContent RenderNodes(IEnumerable<WebsiteBuilder.IRF.Pages.Admin.Navigation.IndexModel.NavNode> nodes, int menuId, int depth)
    {
        var ul = new TagBuilder("ul");
        ul.AddCssClass(depth == 0 ? "list-unstyled mb-0" : "list-unstyled ms-4 mb-0");

        foreach (var n in nodes)
        {
            var li = new TagBuilder("li");
            li.AddCssClass("mb-2");

            var badge = new TagBuilder("span");
            badge.AddCssClass("badge bg-light text-dark border me-2");
            badge.InnerHtml.Append($"M{menuId} · S{n.Item.SortOrder}");

            var label = new TagBuilder("span");
            label.InnerHtml.Append(n.Item.Label ?? "");

            li.InnerHtml.AppendHtml(badge);
            li.InnerHtml.AppendHtml(label);

            if (n.Children != null && n.Children.Any())
            {
                li.InnerHtml.AppendHtml(RenderNodes(n.Children, menuId, depth + 1));
            }

            ul.InnerHtml.AppendHtml(li);
        }

        return ul;
    }
}
