@model WebsiteBuilder.IRF.ViewModels.Admin.Pages.SectionRowVm
@using System.Text.Json

@{
    // Expected JSON shape:
    // { "text": "..." }
    var sectionId = Model.Id;

    string initialText = string.Empty;

    if (!string.IsNullOrWhiteSpace(Model.SettingsJson))
    {
        try
        {
            using var doc = JsonDocument.Parse(Model.SettingsJson);
            if (doc.RootElement.TryGetProperty("text", out var t) && t.ValueKind == JsonValueKind.String)
                initialText = t.GetString() ?? string.Empty;
        }
        catch
        {
            // Invalid JSON: do not crash editor.
            initialText = string.Empty;
        }
    }

    var saveUrl = Url.Page(null, null, new { handler = "SaveSection" }, null);
}

<div class="card border-0 shadow-sm">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="fw-semibold">Text</div>
            <div class="small text-muted" id="save-status-@sectionId"></div>
        </div>

        <textarea class="form-control"
                  id="text-editor-@sectionId"
                  rows="6"
                  placeholder="Type your text here...">@initialText</textarea>

        <div class="mt-2 d-none" id="errors-@sectionId"></div>

        <div class="form-text mt-2">Auto-saves as you type.</div>
    </div>
</div>

<script>
    (function () {
          const sectionId = @sectionId;
          const saveUrl = "@saveUrl";
          const textarea = document.getElementById("text-editor-" + sectionId);
          const statusEl = document.getElementById("save-status-" + sectionId);
          const errorsEl = document.getElementById("errors-" + sectionId);

        function onImageAdded(asset) {
            addToGallery(asset);
            window.PageDirty && window.PageDirty.set();
        }

        function removeImage(id) {
            gallery.splice(index, 1);
            window.PageDirty && window.PageDirty.set();
        }

        onEnd: function () {
            updateGalleryOrder();
            window.PageDirty && window.PageDirty.set();
        }

        altInput.addEventListener("input", function () {
            updateAltText();
            window.PageDirty && window.PageDirty.set();
        });

      function init() {
        if (!textarea) return true;

        // Wait until the helper exists (it loads later via section Scripts)
        if (!window.SectionAutoSave || !window.SectionAutoSave.bindSectionAutoSave) return false;

        const autosave = window.SectionAutoSave.bindSectionAutoSave(
          sectionId,
          () => JSON.stringify({ text: textarea.value ?? "" }),
          saveUrl,
          statusEl,
          errorsEl
        );

        textarea.addEventListener("input", () => autosave.notifyChanged());
        return true;
      }

      if (init()) return;

      // Retry for ~2 seconds to handle script-order timing
      let tries = 0;
      const t = setInterval(() => {
        tries++;
        if (init() || tries > 20) clearInterval(t);
      }, 100);
    })();
</script>
