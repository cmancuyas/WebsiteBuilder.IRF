@model WebsiteBuilder.IRF.ViewModels.Admin.Pages.SectionRowVm
@using System.Text.Json

@{
    var sectionId = Model?.Id ?? 0;

    // Gallery JSON is stored in SettingsJson in your current VM usage
    var initialJson = Model?.SettingsJson ?? "";
    var safeInitialJson = initialJson ?? "";

    // Razor Pages handler URL: OnPostSaveSectionAsync
    var saveUrl = Url.Page(null, null, new { handler = "SaveSection" }, null);
}

<div class="card border-0 shadow-sm">
    <div class="card-body">

        <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap mb-2">
            <div>
                <h5 class="mb-1">Gallery</h5>
                <div class="text-muted small">Select images from Media Library, reorder, and set alt/captions.</div>
            </div>
            <div class="small text-muted" id="save-status-@sectionId"></div>
        </div>

        <div class="mt-2 d-none" id="errors-@sectionId"></div>

        <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap mb-3">
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-primary" id="galleryAddBtn_@sectionId">
                    Add from Media Library
                </button>
                <button type="button" class="btn btn-outline-secondary" id="galleryClearBtn_@sectionId">
                    Clear
                </button>
            </div>
            <div class="text-muted small">Tip: Drag cards to reorder.</div>
        </div>

        <!-- Undo bar -->
        <div class="alert alert-info d-none mb-3" id="galleryUndoBar_@sectionId" role="alert">
            <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
                <div class="small mb-0">Item removed.</div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-primary" id="galleryUndoBtn_@sectionId">Undo</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="galleryUndoDismissBtn_@sectionId">Dismiss</button>
                </div>
            </div>
        </div>

        <!-- Layout controls -->
        <div class="row g-2 mb-3">
            <div class="col-6 col-md-3">
                <label class="form-label small mb-1">Columns</label>
                <select class="form-select form-select-sm" id="galleryColumns_@sectionId">
                    <option value="2">2</option>
                    <option value="3" selected>3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
            <div class="col-6 col-md-3">
                <label class="form-label small mb-1">Spacing</label>
                <select class="form-select form-select-sm" id="gallerySpacing_@sectionId">
                    <option value="sm">Small</option>
                    <option value="md" selected>Medium</option>
                    <option value="lg">Large</option>
                </select>
            </div>
        </div>

        <div class="row g-3" id="galleryGrid_@sectionId"></div>

        <div class="border rounded p-4 text-center text-muted d-none" id="galleryEmpty_@sectionId">
            No images selected yet. Click <strong>Add from Media Library</strong>.
        </div>

        <!-- Hidden JSON used by autosave / safety -->
        <input type="hidden" id="galleryContentJson_@sectionId" value="" />
    </div>
</div>

<script>
    (function () {
        const sectionId = @sectionId;

        // ---------- URLs ----------
        const LOOKUP_URL = "/Admin/Media/Picker?handler=Lookup";
        const saveUrl = "@saveUrl";

        // ---------- DOM ----------
        const addBtn = document.getElementById(`galleryAddBtn_${sectionId}`);
        const clearBtn = document.getElementById(`galleryClearBtn_${sectionId}`);
        const grid = document.getElementById(`galleryGrid_${sectionId}`);
        const empty = document.getElementById(`galleryEmpty_${sectionId}`);
        const hidden = document.getElementById(`galleryContentJson_${sectionId}`);

        const undoBar = document.getElementById(`galleryUndoBar_${sectionId}`);
        const undoBtn = document.getElementById(`galleryUndoBtn_${sectionId}`);
        const undoDismissBtn = document.getElementById(`galleryUndoDismissBtn_${sectionId}`);

        const ddlColumns = document.getElementById(`galleryColumns_${sectionId}`);
        const ddlSpacing = document.getElementById(`gallerySpacing_${sectionId}`);

        const statusEl = document.getElementById(`save-status-${sectionId}`);
        const errorsEl = document.getElementById(`errors-${sectionId}`);

        // server initial JSON (string)
        const serverInitialJson = @Html.Raw(JsonSerializer.Serialize(safeInitialJson));

        // ---------- State ----------
        // Validator shape (root):
        // { images:[{url,alt,caption,mediaAssetId}], columns:number, layout:string }
        let items = [];
        let layout = { columns: 3, spacing: "md" };

        // hydrated lookup: id -> vm
        const lookup = new Map();

        // Undo
        let lastRemoved = null;

        // Autosave binding (Step A2)
        let autosave = null;
        let pendingChange = false;

        function safeParseJson(str) {
            if (!str || typeof str !== "string") return null;
            try { return JSON.parse(str); } catch { return null; }
        }

        function escapeHtml(s) {
            return String(s ?? "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function uniqueById(arr) {
            const seen = new Set();
            const out = [];
            for (const x of arr) {
                const id = Number(x.mediaAssetId);
                if (!id || seen.has(id)) continue;
                seen.add(id);
                out.push(x);
            }
            return out;
        }

        async function postJson(url, body) {
            const token =
                document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]') ||
                document.querySelector('input[name="__RequestVerificationToken"]');

            const headers = { "Content-Type": "application/json" };
            if (token?.value) headers["RequestVerificationToken"] = token.value;

            const res = await fetch(url, {
                method: "POST",
                headers,
                body: JSON.stringify(body || {})
            });

            if (!res.ok) {
                const text = await res.text().catch(() => "");
                throw new Error(`Request failed (${res.status}): ${text}`);
            }
            return await res.json();
        }

        function toContentJson() {
            const cols = Number(layout.columns || 3);
            const spacing = (layout.spacing || "md");

            return JSON.stringify({
                images: items.map(x => {
                    const id = Number(x.mediaAssetId);
                    const vm = lookup.get(id);
                    return {
                        mediaAssetId: id,
                        url: (vm?.Url || "").trim(),
                        alt: (x.altText || "").trim(),
                        caption: (x.caption || "").trim()
                    };
                }),
                columns: cols,
                layout: spacing
            });
        }

        function spacingClass(spacing) {
            switch (spacing) {
                case "sm": return "g-2";
                case "lg": return "g-4";
                case "md":
                default: return "g-3";
            }
        }

        function colClass(columns) {
            const c = Number(columns || 3);
            if (c <= 2) return "col-12 col-md-6";
            if (c === 3) return "col-12 col-sm-6 col-lg-4";
            if (c === 4) return "col-12 col-sm-6 col-lg-3";
            if (c >= 5) return "col-12 col-sm-6 col-lg-2";
            return "col-12 col-sm-6 col-lg-4";
        }

        function applyLayoutToGrid() {
            grid.className = `row ${spacingClass(layout.spacing)}`;
        }

        function resolvePreviewUrl(id) {
            const vm = lookup.get(Number(id));
            if (!vm) return "";
            const u = vm.ThumbUrl || vm.Url;
            return u || "";
        }

        function resolveTitle(id) {
            const vm = lookup.get(Number(id));
            if (!vm) return `Media #${id}`;
            return vm.FileName || `Media #${id}`;
        }

        function resolveIsDeleted(id) {
            const vm = lookup.get(Number(id));
            return vm ? !!vm.IsDeleted : false;
        }

        async function hydrate(ids) {
            const uniq = Array.from(new Set((ids || []).map(x => Number(x)).filter(x => x > 0)));
            const missing = uniq.filter(id => !lookup.has(id));
            if (!missing.length) return;

            const result = await postJson(LOOKUP_URL, { ids: missing });
            if (!result || result.ok !== true) return;

            const list = Array.isArray(result.items) ? result.items : [];
            for (const it of list) {
                const Id = Number(it.id ?? it.Id);
                if (!Id) continue;

                lookup.set(Id, {
                    Id,
                    FileName: it.fileName ?? it.FileName ?? "",
                    ContentType: it.contentType ?? it.ContentType ?? "",
                    AltText: it.altText ?? it.AltText ?? "",
                    Url: it.url ?? it.Url ?? "",
                    ThumbUrl: it.thumbUrl ?? it.ThumbUrl ?? null,
                    IsDeleted: !!(it.isDeleted ?? it.IsDeleted)
                });
            }
        }

        function showUndoBar() { undoBar.classList.remove("d-none"); }
        function hideUndoBar() { undoBar.classList.add("d-none"); lastRemoved = null; }

        // ---------- Step A2: persist hidden + notify autosave ----------
        function updateHiddenAndAutosave() {
            const content = toContentJson();
            hidden.value = content;

            if (autosave) {
                autosave.notifyChanged();
            } else {
                // If helper not ready yet, keep track and mark dirty safely
                pendingChange = true;
                if (window.PageDirty && typeof window.PageDirty.set === "function") {
                    window.PageDirty.set(`section:${sectionId}`);
                }
            }
        }

        function initAutosave() {
            if (!window.SectionAutoSave || !window.SectionAutoSave.bindSectionAutoSave) return false;

            autosave = window.SectionAutoSave.bindSectionAutoSave(
                sectionId,
                () => toContentJson(),
                saveUrl,
                statusEl,
                errorsEl
            );

            // If we marked dirty before autosave existed, clear stale key now;
            // the next notifyChanged() will re-mark and then clear on successful save.
            if (window.PageDirty && typeof window.PageDirty.clear === "function") {
                window.PageDirty.clear(`section:${sectionId}`);
            }

            if (pendingChange) {
                pendingChange = false;
                autosave.notifyChanged();
            }

            return true;
        }

        function ensureAutosaveReady() {
            if (initAutosave()) return;
            let tries = 0;
            const t = setInterval(() => {
                tries++;
                if (initAutosave() || tries > 20) clearInterval(t);
            }, 100);
        }

        function render() {
            grid.innerHTML = "";
            applyLayoutToGrid();

            if (!items.length) empty.classList.remove("d-none");
            else empty.classList.add("d-none");

            items.forEach((it, idx) => {
                const id = Number(it.mediaAssetId);
                const preview = resolvePreviewUrl(id);
                const title = resolveTitle(id);
                const isDeleted = resolveIsDeleted(id);

                const col = document.createElement("div");
                col.className = colClass(layout.columns);

                col.innerHTML = `
                    <div class="card h-100 shadow-sm" draggable="true" data-index="${idx}">
                        <div class="ratio ratio-4x3 bg-light rounded-top overflow-hidden position-relative">
                            ${preview
                                ? `<img src="${preview}" alt="" style="object-fit:cover;width:100%;height:100%;">`
                                : `<div class="d-flex align-items-center justify-content-center text-muted small">No preview</div>`}
                            ${isDeleted
                                ? `<div class="position-absolute top-0 start-0 m-2 badge bg-danger">Deleted</div>`
                                : ``}
                        </div>

                        <div class="card-body p-2">
                            <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                                <div class="small text-muted text-truncate" title="${escapeHtml(title)}">
                                    ${escapeHtml(title)}
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-remove="${idx}">
                                    Remove
                                </button>
                            </div>

                            <div class="mb-2">
                                <label class="form-label small mb-1">Alt text</label>
                                <input type="text" class="form-control form-control-sm"
                                       value="${escapeHtml(it.altText || "")}" data-alt="${idx}" />
                            </div>

                            <div>
                                <label class="form-label small mb-1">Caption</label>
                                <input type="text" class="form-control form-control-sm"
                                       value="${escapeHtml(it.caption || "")}" data-caption="${idx}" />
                            </div>
                        </div>
                    </div>
                `;

                grid.appendChild(col);
            });

            grid.querySelectorAll("[data-remove]").forEach(btn => {
                btn.addEventListener("click", () => removeAt(Number(btn.getAttribute("data-remove"))));
            });

            grid.querySelectorAll("[data-alt]").forEach(inp => {
                inp.addEventListener("input", () => {
                    const i = Number(inp.getAttribute("data-alt"));
                    items[i].altText = inp.value || "";
                    updateHiddenAndAutosave();
                });
            });

            grid.querySelectorAll("[data-caption]").forEach(inp => {
                inp.addEventListener("input", () => {
                    const i = Number(inp.getAttribute("data-caption"));
                    items[i].caption = inp.value || "";
                    updateHiddenAndAutosave();
                });
            });

            setupDragAndDrop();
        }

        function removeAt(index) {
            if (index < 0 || index >= items.length) return;
            lastRemoved = { item: items[index], index };
            items.splice(index, 1);

            render();
            updateHiddenAndAutosave();
            showUndoBar();
        }

        undoBtn?.addEventListener("click", () => {
            if (!lastRemoved) return;
            const { item, index } = lastRemoved;
            items.splice(Math.min(index, items.length), 0, item);
            hideUndoBar();
            render();
            updateHiddenAndAutosave();
        });

        undoDismissBtn?.addEventListener("click", hideUndoBar);

        function setupDragAndDrop() {
            const cards = grid.querySelectorAll(".card[draggable='true']");
            let dragIndex = null;

            cards.forEach(card => {
                card.addEventListener("dragstart", (e) => {
                    dragIndex = Number(card.getAttribute("data-index"));
                    e.dataTransfer.effectAllowed = "move";
                });

                card.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = "move";
                });

                card.addEventListener("drop", (e) => {
                    e.preventDefault();
                    const dropIndex = Number(card.getAttribute("data-index"));
                    if (dragIndex === null || dropIndex === null || dragIndex === dropIndex) return;

                    const moved = items.splice(dragIndex, 1)[0];
                    items.splice(dropIndex, 0, moved);

                    dragIndex = null;
                    render();
                    updateHiddenAndAutosave();
                });

                card.addEventListener("dragend", () => { dragIndex = null; });
            });
        }

        function normalizePickerItems(payload) {
            if (!payload) return [];
            if (Array.isArray(payload)) return payload;
            if (Array.isArray(payload.items)) return payload.items;
            if (Array.isArray(payload.assets)) return payload.assets;
            if (payload.item) return [payload.item];
            if (payload.asset) return [payload.asset];
            return [];
        }

        async function onPickerSelection(payload) {
            const raw = normalizePickerItems(payload);

            const selected = raw.map(x => {
                const id = Number(x.id ?? x.Id ?? x.mediaAssetId ?? x.MediaAssetId);
                return {
                    mediaAssetId: id,
                    altText: (x.altText ?? x.AltText ?? ""),
                    caption: (x.caption ?? x.Caption ?? "")
                };
            }).filter(x => x.mediaAssetId > 0);

            if (!selected.length) return;

            items = uniqueById([...items, ...selected]);

            await hydrate(items.map(x => x.mediaAssetId));

            hideUndoBar();
            render();
            updateHiddenAndAutosave();
        }

        function openPicker() {
            if (typeof window.openMediaPicker === "function") {
                window.openMediaPicker({
                    multiple: true,
                    onSelect: (payload) => onPickerSelection(payload)
                });
                return;
            }

            const w = window.open("/Admin/Media/Picker", "MediaPicker", "width=1200,height=800");
            if (!w) alert("Popup blocked. Please allow popups for this site to use the Media Picker.");
        }

        addBtn?.addEventListener("click", openPicker);

        window.addEventListener("media:selected", (e) => onPickerSelection(e.detail));
        window.addEventListener("message", (e) => {
            const data = e.data;
            if (!data) return;
            if (data.type === "media:selected") {
                onPickerSelection(data.payload || data);
            }
        });

        clearBtn?.addEventListener("click", () => {
            items = [];
            lookup.clear();
            hideUndoBar();
            render();
            updateHiddenAndAutosave();
        });

        ddlColumns?.addEventListener("change", () => {
            layout.columns = Number(ddlColumns.value || 3);
            render();
            updateHiddenAndAutosave();
        });

        ddlSpacing?.addEventListener("change", () => {
            layout.spacing = ddlSpacing.value || "md";
            render();
            updateHiddenAndAutosave();
        });

        // ---------- Init ----------
        (async function init() {
            // Bind autosave first (so first mutation is captured)
            ensureAutosaveReady();

            const parsed = safeParseJson(serverInitialJson);

            if (parsed && typeof parsed === "object") {
                // root layout/columns shape
                if (typeof parsed.layout === "string") layout.spacing = parsed.layout || "md";
                if (typeof parsed.columns === "number") layout.columns = Number(parsed.columns || 3);

                if (Array.isArray(parsed.images)) {
                    items = parsed.images.map(x => ({
                        mediaAssetId: Number(x.mediaAssetId || x.id),
                        altText: x.alt || "",
                        caption: x.caption || ""
                    })).filter(x => x.mediaAssetId > 0);
                }
            }

            ddlColumns.value = String(layout.columns || 3);
            ddlSpacing.value = String(layout.spacing || "md");

            await hydrate(items.map(x => x.mediaAssetId));

            // Set hidden immediately (safety) WITHOUT marking dirty
            hidden.value = toContentJson();

            render();
        })();
    })();
</script>
