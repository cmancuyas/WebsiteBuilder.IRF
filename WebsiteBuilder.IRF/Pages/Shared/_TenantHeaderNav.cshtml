@using Microsoft.AspNetCore.Html
@using Microsoft.AspNetCore.Mvc.Rendering
@using WebsiteBuilder.IRF.Infrastructure.Tenancy
@inject WebsiteBuilder.IRF.Infrastructure.Tenancy.ITenantNavigationService NavService
@inject WebsiteBuilder.IRF.Infrastructure.Tenancy.ITenantContext TenantContext

@functions {
    private IHtmlContent RenderNavItems(
        IReadOnlyList<NavItem> items,
        bool isDropdown = false)
    {
        var ul = new TagBuilder("ul");
        ul.AddCssClass(isDropdown ? "dropdown-menu" : "navbar-nav me-auto mb-2 mb-lg-0");

        foreach (var item in items)
        {
            var hasChildren = item.Children?.Count > 0;

            var li = new TagBuilder("li");
            li.AddCssClass(hasChildren && !isDropdown ? "nav-item dropdown" : "nav-item");

            var a = new TagBuilder("a");

            // -------------------------------
            // NORMALIZE HOME URL
            // -------------------------------
            var href = string.IsNullOrWhiteSpace(item.Url) ? "/" : item.Url.Trim();

            if (string.Equals(href, "/home", StringComparison.OrdinalIgnoreCase))
            {
                href = "/";
            }

            a.Attributes["href"] = href;

            if (item.OpenInNewTab)
            {
                a.Attributes["target"] = "_blank";
                a.Attributes["rel"] = "noopener";
            }

            if (!isDropdown)
            {
                a.AddCssClass(hasChildren ? "nav-link dropdown-toggle" : "nav-link");

                if (hasChildren)
                {
                    a.Attributes["role"] = "button";
                    a.Attributes["data-bs-toggle"] = "dropdown";
                    a.Attributes["aria-expanded"] = "false";
                }
            }
            else
            {
                a.AddCssClass("dropdown-item");
            }

            a.InnerHtml.Append(item.Title);
            li.InnerHtml.AppendHtml(a);

            if (hasChildren)
            {
                li.InnerHtml.AppendHtml(RenderNavItems(item.Children!, true));
            }

            ul.InnerHtml.AppendHtml(li);
        }

        return ul;
    }
}

@if (TenantContext.IsResolved)
{
    var headerItems = await NavService.GetHeaderAsync();

    if (headerItems.Count > 0)
    {
        @RenderNavItems(headerItems)
    }
}
