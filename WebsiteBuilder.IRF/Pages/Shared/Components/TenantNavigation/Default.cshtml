@model IReadOnlyList<NavItem>
@using Microsoft.AspNetCore.Http
@using WebsiteBuilder.IRF.Infrastructure.Tenancy

@{
    int idx = 0;

    static string NormalizePath(string? urlOrPath)
    {
        if (string.IsNullOrWhiteSpace(urlOrPath))
            return "/";

        // If absolute URL, extract path
        if (Uri.TryCreate(urlOrPath, UriKind.Absolute, out var abs))
            urlOrPath = abs.AbsolutePath;

        var p = urlOrPath!.Trim();

        if (!p.StartsWith("/"))
            p = "/" + p;

        // Strip query if present
        var q = p.IndexOf("?", StringComparison.Ordinal);
        if (q >= 0)
            p = p.Substring(0, q);

        if (p.Length > 1 && p.EndsWith("/"))
            p = p.TrimEnd('/');

        return p;
    }

    bool IsActive(string? itemUrl)
    {
        var current = NormalizePath(Context.Request.Path.Value);
        var target = NormalizePath(itemUrl);

        if (target == "/")
            return current == "/";

        return current.Equals(target, StringComparison.OrdinalIgnoreCase)
               || current.StartsWith(target + "/", StringComparison.OrdinalIgnoreCase);
    }
}

<ul class="navbar-nav me-auto mb-2 mb-lg-0">
    @foreach (var item in Model)
    {
        var hasChildren = item.Children != null && item.Children.Count > 0;

        // Parent is active if it matches OR any child matches
        var isActive = IsActive(item.Url) ||
        (hasChildren && item.Children!.Any(c => IsActive(c.Url)));

        if (!hasChildren)
        {
            <li class="nav-item">
                <a class="nav-link text-dark @(isActive ? "active" : "")"
                   href="@item.Url"
                   target="@(item.OpenInNewTab ? "_blank" : null)"
                   rel="@(item.OpenInNewTab ? "noopener noreferrer" : null)">
                    @item.Title
                </a>
            </li>
        }
        else
        {
            var ddId = $"tenant-nav-dd-{idx++}";

            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle text-dark @(isActive ? "active" : "")"
                   href="@item.Url"
                   id="@ddId"
                   role="button"
                   data-bs-toggle="dropdown"
                   aria-expanded="false">
                    @item.Title
                </a>

                <ul class="dropdown-menu" aria-labelledby="@ddId">
                    @foreach (var child in item.Children!)
                    {
                        var childActive = IsActive(child.Url);

                        <li>
                            <a class="dropdown-item @(childActive ? "active" : "")"
                               href="@child.Url"
                               target="@(child.OpenInNewTab ? "_blank" : null)"
                               rel="@(child.OpenInNewTab ? "noopener noreferrer" : null)">
                                @child.Title
                            </a>
                        </li>
                    }
                </ul>
            </li>
        }
    }
</ul>
